/*! angular-joystick */
"use strict";angular.module("angular-joystick",[]),angular.module("angular-joystick").directive("angularJoystick",["JoystickService",function(a){return{restrict:"EA",scope:{coords:"=",onMove:"&"},template:'<div ng-mousedown="joystick.startControl()" ng-mouseup="joystick.endControl()" ng-mousemove="joystick.move($event)" ><canvas id="joystickCanvas" width="{{joystick.squareSize}}" height="{{joystick.squareSize}}" style="width: {{joystick.squareSize}}px; height: {{joystick.squareSize}}px;"></canvas></div>',controller:["$scope",function(b){b.joystick=a.get(b.coords,b.onMove),b.$on("$destroy",function(){b.joystick={}})}]}}]),angular.module("angular-joystick").provider("JoystickService",function(){this.$get=["$timeout",function(a){function b(a,b){var c=new Image;return c.onload=b,c.src=a,c}var c,d,e=0,f=1,g=.5,h=150,i=e,j={x:0,y:0},k=null,l=null,m=null,n=h/2*.5,o=!1,p=!1,q=(new Date).getTime(),r={get:function(a,b){return a&&(j=a),b&&(k=b),r},coords:j,squareSize:h,_retractJoystickForInactivity:function(){var b=15;a(function(){var a=(new Date).getTime();a-q>=1e3*g&&(r._retractToMiddle(),r.renderSprite()),r._retractJoystickForInactivity()},parseInt(1e3/b,10))},_tryCallback:function(){d&&o&&(m||r.render(),r.renderSprite())},startControl:function(){console.log("startControl"),i=f},endControl:function(){console.log("endControl"),i=e,j.x=0,j.y=0,r.renderSprite()},move:function(a){if(i!==e){q=(new Date).getTime();var b,c;if(a.originalEvent&&a.originalEvent.touches){a.preventDefault();for(var d=0,f=0,g=$(l)[0];g;)d+=parseInt(g.offsetLeft),f+=parseInt(g.offsetTop),g=g.offsetParent;b=a.originalEvent.touches[0].clientX-d,c=a.originalEvent.touches[0].clientY-f}else b=a.offsetX,c=a.offsetY;r._mutateToCartesian(b,c),r._triggerChange()}},_triggerChange:function(){var a=j.x/n,b=j.y/n;Math.abs(a)>1&&(a/=Math.abs(a)),Math.abs(b)>1&&(b/=Math.abs(b)),k()},_mutateToCartesian:function(a,b){a-=h/2,b*=-1,b+=h/2,isNaN(b)&&(b=h/2),j.x=a,j.y=b,r._valuesExceedRadius(j.x,j.y)&&r._traceNewValues(),r.renderSprite()},_retractToMiddle:function(){var a=.1,b=1-a,c=1,d=1;0!==j.x&&(c=j.x/Math.abs(j.x)),0!==j.y&&(d=j.y/Math.abs(j.y)),j.x=Math.floor(b*Math.abs(j.x))*c,j.y=Math.floor(b*Math.abs(j.y))*d},_traceNewValues:function(){var a,b=j.y/j.x,c=1;j.x<0&&(c=-1);for(var d=0;h/2>d&&(a=d*b,!r._valuesExceedRadius(d,a));d+=c);j.x=d,j.y=a},_cartesianToCanvas:function(a,b){var c=a+h/2,d=b-h/2;return d=-1*d,{x:c,y:d}},_valuesExceedRadius:function(a,b){return 0===a?b>n:Math.pow(a,2)+Math.pow(b,2)>Math.pow(n,2)},renderSprite:function(){var a=89,b=89,e=50,f=50,g=0,i=0,k=r._cartesianToCanvas(j.x,j.y);if(null===m)return void console.log("context is null :(");m.clearRect(0,0,2*h,h);var l=300;m.drawImage(d,0,0,l,l,0,0,h,h),m.drawImage(c,g,i,a,b,k.x-e/2,k.y-f/2,e,f)},render:function(){return l=$("#joystickCanvas")[0],console.log("render "+l),m=l.getContext("2d"),r.renderSprite(),this}};return c=b("assets/images/button.png",function(){o=!0,r._tryCallback()}),d=b("assets/images/canvas.png",function(){p=!0,r._tryCallback()}),r}]});